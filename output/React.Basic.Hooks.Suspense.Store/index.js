// Generated by purs version 0.15.2
import * as Control_Alt from "../Control.Alt/index.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_Error_Class from "../Control.Monad.Error.Class/index.js";
import * as Data_DateTime_Instant from "../Data.DateTime.Instant/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_HeytingAlgebra from "../Data.HeytingAlgebra/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Newtype from "../Data.Newtype/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Time_Duration from "../Data.Time.Duration/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Console from "../Effect.Console/index.js";
import * as Effect_Exception from "../Effect.Exception/index.js";
import * as Effect_Now from "../Effect.Now/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as React_Basic_Hooks_Suspense from "../React.Basic.Hooks.Suspense/index.js";
import * as Web_HTML from "../Web.HTML/index.js";
import * as Web_HTML_Window from "../Web.HTML.Window/index.js";
var $runtime_lazy = function (name, moduleName, init) {
    var state = 0;
    var val;
    return function (lineNumber) {
        if (state === 2) return val;
        if (state === 1) throw new ReferenceError(name + " was needed before it finished initializing (module " + moduleName + ", line " + lineNumber + ")", moduleName, lineNumber);
        state = 1;
        val = init();
        state = 2;
        return val;
    };
};
var SuspenseStore = function (x) {
    return x;
};
var mkSuspenseStore = function (dictOrd) {
    return function (defaultMaxAge) {
        return function (backend) {
            return function __do() {
                var ref = Effect_Ref["new"](Data_Map_Internal.empty)();
                var isExpired = function (maxAge) {
                    return function (now$prime) {
                        return function (v) {
                            return Data_Ord.lessThan(Data_Time_Duration.ordMilliseconds)(Data_DateTime_Instant.unInstant(now$prime))(Data_Semigroup.append(Data_Time_Duration.semigroupMilliseconds)(Data_DateTime_Instant.unInstant(v.value1))(maxAge));
                        };
                    };
                };
                var $lazy_pruneCache = $runtime_lazy("pruneCache", "React.Basic.Hooks.Suspense.Store", function () {
                    if (defaultMaxAge instanceof Data_Maybe.Nothing) {
                        return Control_Applicative.pure(Effect.applicativeEffect)(Data_Unit.unit);
                    };
                    if (defaultMaxAge instanceof Data_Maybe.Just) {
                        return function __do() {
                            var now$prime = Effect_Now.now();
                            Data_Functor["void"](Effect.functorEffect)(Effect_Ref.modify(Data_Map_Internal.filter(dictOrd)(Data_HeytingAlgebra.not(Data_HeytingAlgebra.heytingAlgebraFunction(Data_HeytingAlgebra.heytingAlgebraFunction(Data_HeytingAlgebra.heytingAlgebraFunction(Data_HeytingAlgebra.heytingAlgebraBoolean))))(isExpired)(defaultMaxAge.value0)(now$prime)))(ref))();
                            return Data_Functor["void"](Effect.functorEffect)(Control_Bind.bind(Effect.bindEffect)(Web_HTML.window)(Web_HTML_Window.requestIdleCallback({
                                timeout: Data_Int.ceil(Data_Newtype.un()(Data_Time_Duration.Milliseconds)(defaultMaxAge.value0))
                            })($lazy_pruneCache(54))))();
                        };
                    };
                    throw new Error("Failed pattern match at React.Basic.Hooks.Suspense.Store (line 44, column 7 - line 54, column 27): " + [ defaultMaxAge.constructor.name ]);
                });
                var pruneCache = $lazy_pruneCache(43);
                var tryFromCache = function (itemMaxAge) {
                    return function (k) {
                        return function __do() {
                            var rMaybe = Data_Functor.map(Effect.functorEffect)(Data_Map_Internal.lookup(dictOrd)(k))(Effect_Ref.read(ref))();
                            if (rMaybe instanceof Data_Maybe.Nothing) {
                                return Data_Maybe.Nothing.value;
                            };
                            if (rMaybe instanceof Data_Maybe.Just) {
                                var v1 = Control_Alt.alt(Data_Maybe.altMaybe)(itemMaxAge)(defaultMaxAge);
                                if (v1 instanceof Data_Maybe.Nothing) {
                                    return new Data_Maybe.Just(rMaybe.value0.value0);
                                };
                                if (v1 instanceof Data_Maybe.Just) {
                                    var now$prime = Effect_Now.now();
                                    var $15 = isExpired(v1.value0)(now$prime)(rMaybe.value0);
                                    if ($15) {
                                        Effect_Ref.modify(Data_Map_Internal["delete"](dictOrd)(k))(ref)();
                                        return Data_Maybe.Nothing.value;
                                    };
                                    return new Data_Maybe.Just(rMaybe.value0.value0);
                                };
                                throw new Error("Failed pattern match at React.Basic.Hooks.Suspense.Store (line 61, column 11 - line 69, column 30): " + [ v1.constructor.name ]);
                            };
                            throw new Error("Failed pattern match at React.Basic.Hooks.Suspense.Store (line 58, column 7 - line 69, column 30): " + [ rMaybe.constructor.name ]);
                        };
                    };
                };
                var getCacheOrBackend = function (itemMaxAge) {
                    return function (k) {
                        return function __do() {
                            var c = tryFromCache(itemMaxAge)(k)();
                            if (c instanceof Data_Maybe.Just) {
                                return c.value0;
                            };
                            if (c instanceof Data_Maybe.Nothing) {
                                var fiber = Effect_Aff.launchAff(Control_Bind.bind(Effect_Aff.bindAff)(Effect_Aff.attempt(backend(k)))(function (r) {
                                    return Effect_Class.liftEffect(Effect_Aff.monadEffectAff)((function () {
                                        var v = (function () {
                                            if (r instanceof Data_Either.Left) {
                                                return new React_Basic_Hooks_Suspense.Failed(r.value0);
                                            };
                                            if (r instanceof Data_Either.Right) {
                                                return new React_Basic_Hooks_Suspense.Complete(r.value0);
                                            };
                                            throw new Error("Failed pattern match at React.Basic.Hooks.Suspense.Store (line 81, column 23 - line 83, column 44): " + [ r.constructor.name ]);
                                        })();
                                        return function __do() {
                                            var d = Effect_Now.now();
                                            Effect_Ref.modify(Data_Map_Internal.alter(dictOrd)(function (v1) {
                                                if (v1 instanceof Data_Maybe.Nothing) {
                                                    return new Data_Maybe.Just(new Data_Tuple.Tuple(v, d));
                                                };
                                                if (v1 instanceof Data_Maybe.Just) {
                                                    var $26 = Data_Ord.greaterThan(Data_DateTime_Instant.ordDateTime)(d)(v1.value0.value1);
                                                    if ($26) {
                                                        return new Data_Maybe.Just(new Data_Tuple.Tuple(v, d));
                                                    };
                                                    return new Data_Maybe.Just(v1.value0);
                                                };
                                                throw new Error("Failed pattern match at React.Basic.Hooks.Suspense.Store (line 89, column 41 - line 95, column 44): " + [ v1.constructor.name ]);
                                            })(k))(ref)();
                                            if (r instanceof Data_Either.Left) {
                                                return Control_Monad_Error_Class.throwError(Control_Monad_Error_Class.monadThrowEffect)(r.value0)();
                                            };
                                            if (r instanceof Data_Either.Right) {
                                                return r.value0;
                                            };
                                            throw new Error("Failed pattern match at React.Basic.Hooks.Suspense.Store (line 97, column 17 - line 99, column 38): " + [ r.constructor.name ]);
                                        };
                                    })());
                                }))();
                                var v = new React_Basic_Hooks_Suspense.InProgress(fiber);
                                var d = Effect_Now.now();
                                Effect_Ref.modify(Data_Map_Internal.insert(dictOrd)(k)(new Data_Tuple.Tuple(v, d)))(ref)();
                                return v;
                            };
                            throw new Error("Failed pattern match at React.Basic.Hooks.Suspense.Store (line 73, column 7 - line 104, column 17): " + [ c.constructor.name ]);
                        };
                    };
                };
                (function __do() {
                    var r = Effect_Exception["try"](pruneCache)();
                    if (r instanceof Data_Either.Left) {
                        return Effect_Console.warn("Failed to initialize the suspense store cleanup task. Ensure you're using it in a browser with `requestIdleCallback` support.")();
                    };
                    if (r instanceof Data_Either.Right) {
                        return Data_Unit.unit;
                    };
                    throw new Error("Failed pattern match at React.Basic.Hooks.Suspense.Store (line 107, column 5 - line 109, column 27): " + [ r.constructor.name ]);
                })();
                return {
                    cache: ref,
                    get: (function () {
                        var $39 = Data_Functor.map(Data_Functor.functorFn)(React_Basic_Hooks_Suspense.Suspended);
                        return function ($40) {
                            return $39(getCacheOrBackend($40));
                        };
                    })()
                };
            };
        };
    };
};
var get$prime = function (v) {
    return function (d) {
        return v.get(new Data_Maybe.Just(d));
    };
};
var get = function (v) {
    return v.get(Data_Maybe.Nothing.value);
};
export {
    mkSuspenseStore,
    get,
    get$prime
};
